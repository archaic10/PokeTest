name: Node.js CI
'on':
  pull_request:
    branches:
    - main
jobs:
  build:
    name: Npm install & build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js 14.x
      uses: actions/setup-node@v2
      with:
        node-version: 14.x
    - run: npm ci
    - run: npm run build --if-present
  test:
    needs: build
    name: Npm test & coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js 14.x
      uses: actions/setup-node@v2
      with:
        node-version: 14.x
    - run: npm ci
    - run: npm run coverage
    - name: Archive code coverage results
      uses: actions/upload-artifact@v1
      with:
        name: code-coverage-report
        path: coverage
  Automação Jira:
    name: Jira CI
    'on':
      push:
        branches:
        - main
    jobs:
      test-transition-issue:
        name: Transition Issue
        runs-on: ubuntu-latest
        steps:
        - name: Extract branch name
          shell: bash
          run: echo "##[set-output name=branch;]$(echo ${{github.event.pull_request.head.ref}}
            | awk -F/ '{print $NF}')"
          id: extract_branch
        - name: Login
          uses: atlassian/gajira-login@master
          env:
            JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
            JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
            JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
            branch_name: ${{github.event.pull_request.head.ref}}
        - name: Comment on issue
          uses: atlassian/gajira-comment@master
          with:
            issue: ${{ steps.extract_branch.outputs.branch }}
            comment: ${{secrets.JIRA_COMMENT_DONE}}
        - name: Transition issue
          uses: atlassian/gajira-transition@master
          with:
            issue: ${{ steps.extract_branch.outputs.branch }}
            transition: ${{secrets.JIRA_STEP_DONE}}
  sonarcloud:
    needs: test
    name: Sonarcloud scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - uses: actions/download-artifact@v1
      with:
        name: code-coverage-report
        path: coverage
    - uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_XPTO }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
